:root {
    /* Inherit from whatever theme ST is using */
    --sb-glass-border: rgba(128, 128, 128, 0.2);
    --sb-accent: var(--SmartThemeEmColor, var(--SmartThemeQuoteColor, var(--mes-edit-color, #6366f1)));
    --sb-accent-hover: color-mix(in srgb, var(--sb-accent) 80%, white);
    --sb-text-primary: inherit;
    --sb-text-secondary: inherit;
    --sb-text-muted: inherit;
    --sb-radius: 12px;
    --sb-sidebar-width: 180px;
}

.sb-container {
    position: fixed;
    top: 80px;
    left: 80px;
    width: 620px;
    height: 500px;
    background: rgba(0, 0, 0, var(--sb-opacity, 0.85));
    backdrop-filter: blur(12px) saturate(120%);
    -webkit-backdrop-filter: blur(12px) saturate(120%);
    border: 1px solid var(--sb-glass-border);
    border-radius: var(--sb-radius);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    display: flex !important;
    flex-direction: column;
    z-index: 1;
    /* Baseline: managed by focusWindow in JS */
    overflow: hidden;
    resize: both;
    min-width: 450px;
    min-height: 350px;
    max-width: 100vw;
    max-height: 100vh;
    color: inherit;
    font-family: inherit;
    transition: box-shadow 0.2s ease, border-color 0.2s ease;
    font-size: var(--sb-font-size, 0.9rem);
    /* Performance */
    will-change: transform;
    contain: layout style;
}

/* Prevent window from going under ST top bar on mobile */
@media (max-width: 768px) {
    .sb-container:not(.sb-fullscreen) {
        top: max(36px, var(--top, 36px)) !important;
    }
}

.sb-container.sb-locked .sb-header {
    cursor: default;
}

.sb-container.sb-locked .sb-header:active {
    cursor: default;
}

.sb-container.sb-locked .sb-sidebar-resizer {
    display: none;
    pointer-events: none;
}

.sb-container.sb-locked .sb-window-resizer {
    display: none;
    pointer-events: none;
}

.sb-container.sb-focus {
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    border-color: rgba(255, 255, 255, 0.15);
}

/* Fullscreen Mode */
.sb-container.sb-fullscreen {
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    border-radius: 0 !important;
    resize: none !important;
}

/* Header */
.sb-header {
    height: 48px;
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    padding: 0 12px;
    background: rgba(0, 0, 0, 0.25);
    border-bottom: 1px solid var(--sb-glass-border);
    cursor: grab;
    flex-shrink: 0;
    user-select: none;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    position: relative;
    transition: background 0.2s;
}

.sb-header:active {
    cursor: grabbing;
    background: rgba(0, 0, 0, 0.3);
}

.sb-controls-left {
    grid-column: 1;
    justify-self: start;
    display: flex;
    align-items: center;
    gap: 4px;
}

.sb-title {
    grid-column: 2;
    justify-self: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--sb-text-primary);
    overflow: visible;
    cursor: pointer;
    position: relative;
}

/* No max-width needed - grid handles spacing */

/* Grid layout handles spacing - icons can be shown on mobile now */

.sb-title-text {
    white-space: nowrap;
}

.sb-title i {
    color: var(--sb-accent);
    font-size: 1rem;
    flex-shrink: 0;
}

.sb-controls {
    grid-column: 3;
    justify-self: end;
    display: flex;
    gap: 4px;
    align-items: center;
}

.sb-control-btn {
    cursor: pointer;
    font-size: 0.9rem;
    color: var(--sb-text-secondary);
    padding: 6px 8px;
    border-radius: 6px;
    transition: all 0.15s ease;
}

.sb-control-btn:hover {
    color: var(--sb-text-primary);
    background: rgba(255, 255, 255, 0.1);
}

/* Header-specific circular buttons */
.sb-controls .sb-control-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--sb-glass-border);
    background: rgba(0, 0, 0, 0.3);
    font-size: 0.95rem;
}

#spell-book-controls .sb-control-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--sb-text-muted);
}

/* Main Layout */
.sb-main {
    display: flex;
    flex: 1;
    overflow: hidden;
    min-height: 0;
    position: relative;
}

/* Sidebar */
.sb-sidebar {
    width: var(--sb-sidebar-width);
    background: rgba(0, 0, 0, 0.15);
    border-right: 1px solid var(--sb-glass-border);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    position: relative;
}

.sb-sidebar-resizer {
    position: absolute;
    top: 0;
    bottom: 0;
    right: -3px;
    width: 6px;
    cursor: col-resize;
    z-index: 100;
    transition: background 0.2s;
}



.sb-sidebar-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-bottom: 1px solid var(--sb-glass-border);
    flex-shrink: 0;
}

.sb-sidebar-header span {
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.7;
}

.sb-sidebar-resizer:hover,
.sb-sidebar-resizer:active {
    background: var(--sb-accent);
}

.sb-sidebar-row {
    display: flex;
    align-items: center;
    gap: 6px;
}

.sb-sidebar-row>.sb-control-btn {
    font-size: 0.7rem;
    padding: 4px 6px;
}

.sb-category-selector {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.05);
    transition: background 0.15s;
}

.sb-category-selector:hover {
    background: rgba(255, 255, 255, 0.1);
}

.sb-category-name {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--sb-text-primary);
    flex: 1;
    text-transform: none;
}

.sb-cat-chevron {
    font-size: 0.85rem;
    color: var(--sb-text-muted);
    margin-left: 6px;
    opacity: 0.7;
}

.sb-cat-delete {
    font-size: 0.7rem;
    color: var(--sb-text-muted);
    padding: 4px;
    opacity: 0;
    transition: opacity 0.15s;
}

.sb-category-selector:hover .sb-cat-delete {
    opacity: 0.6;
}

.sb-cat-delete:hover {
    color: #f87171 !important;
    opacity: 1 !important;
}

.sb-category-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    /* Relative to .sb-header or .sb-title */
    left: 50%;
    transform: translateX(-50%);
    width: 250px;
    background: rgba(20, 20, 25, 0.98);
    border: 1px solid var(--sb-glass-border);
    border-radius: 6px;
    z-index: 1001;
    max-height: 250px;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
}

.sb-cat-item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.15s;
    display: flex;
    align-items: center;
    gap: 10px;
}

.sb-cat-item:hover {
    background: rgba(255, 255, 255, 0.08);
}

.sb-cat-item.active {
    background: rgba(255, 255, 255, 0.1);
    color: var(--sb-accent);
}

.sb-cat-icon-display {
    width: 20px;
    text-align: center;
    color: var(--sb-accent);
    opacity: 0.8;
    flex-shrink: 0;
}

.sb-cat-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
}

.sb-cat-actions {
    display: flex;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.2s ease;
    flex-shrink: 0;
}

.sb-cat-item:hover .sb-cat-actions {
    opacity: 1;
}

.sb-cat-actions i {
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--sb-text-secondary);
    transition: all 0.15s ease;
}

.sb-cat-actions i:hover {
    color: var(--sb-text-primary);
}

.sb-cat-popout:hover {
    color: var(--sb-accent) !important;
}

.sb-cat-change-icon:hover {
    color: var(--sb-accent) !important;
}

.sb-cat-trash:hover {
    color: #ff5555 !important;
}

.sb-cat-add {
    border-top: 1px solid var(--sb-glass-border);
    color: var(--sb-accent);
    display: flex;
    align-items: center;
    gap: 6px;
}

.sb-cat-input {
    flex: 1;
}

.sb-sidebar-header>.sb-control-btn {
    align-self: flex-end;
    font-size: 0.75rem;
    padding: 4px 6px;
}

.sb-page-list {
    flex: 1;
    overflow-y: auto;
    list-style: none;
    padding: 0 6px 6px;
    margin: 0;
}

.sb-page-item {
    padding: 10px 12px;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.15s ease;
    font-size: 0.85rem;
    margin-bottom: 2px;
    color: var(--sb-text-secondary);
}

.sb-page-item:hover {
    background: rgba(255, 255, 255, 0.06);
    color: var(--sb-text-primary);
}

.sb-page-item.active {
    background: rgba(99, 102, 241, 0.15);
    color: inherit;
}

.sb-page-item span {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.sb-page-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    max-width: 0;
    overflow: hidden;
    transition: all 0.2s ease;
}

.sb-page-item:hover .sb-page-actions {
    opacity: 1;
    max-width: 80px;
}

.sb-page-edit,
.sb-page-delete {
    font-size: 0.7rem;
    padding: 4px;
    cursor: pointer;
    transition: color 0.15s;
}

.sb-page-edit:hover,
.sb-page-move:hover {
    color: var(--sb-accent);
}

.sb-page-delete {
    color: var(--sb-text-muted);
}

.sb-page-delete:hover {
    color: #ff5555 !important;
}

.sb-inline-input {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--sb-accent);
    color: var(--sb-text-primary);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    width: 100%;
    outline: none;
}

/* Content Wrapper */
.sb-content-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    min-width: 0;
    height: 100%;
}

.sb-content {
    flex: 1;
    padding: 20px 24px;
    overflow-y: auto;
    background: transparent;
    font-size: 0.9rem;
    line-height: 1.65;
    min-height: 0;
}

/* Editor */
.sb-editor-container {
    flex: 1;
    background: rgba(10, 10, 15, 0.98);
    display: none;
    flex-direction: column;
    z-index: 100;
    min-height: 0;
    /* Important for flex stretching */
}

/* No longer needed as we use .css('display', 'flex') which works on its own */

.sb-editor {
    flex: 1 !important;
    background: transparent;
    border: none;
    color: var(--sb-text-primary);
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    padding: 20px 24px;
    resize: none;
    font-size: 0.85rem;
    line-height: 1.7;
    width: 100%;
    box-sizing: border-box;
}

.sb-editor:focus {
    outline: none;
}

.sb-editor-footer {
    padding: 10px 16px;
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    border-top: 1px solid var(--sb-glass-border);
    background: rgba(0, 0, 0, 0.2);
}

/* Editor Toolbar */
.sb-editor-toolbar {
    display: flex;
    align-items: center;
    gap: 2px;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid var(--sb-glass-border);
}

.sb-fmt-btn {
    background: transparent;
    border: none;
    color: var(--sb-text-secondary);
    padding: 6px 8px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.15s;
}

.sb-fmt-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--sb-text-primary);
}

.sb-toolbar-divider {
    width: 1px;
    height: 18px;
    background: var(--sb-glass-border);
    margin: 0 6px;
}

.sb-fmt-select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--sb-glass-border);
    color: var(--sb-text-secondary);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
}

/* Fullscreen Mode */
.sb-container.sb-fullscreen {
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    border-radius: 0;
}

.sb-save-edit-btn,
.sb-cancel-edit-btn {
    width: 2em;
    height: 2em;
    border-radius: 50%;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255, 255, 255, 0.08);
    /* Dark default */
    color: var(--sb-text-secondary);
}

.sb-save-edit-btn {
    background: var(--sb-accent);
    color: white;
}

.sb-save-edit-btn:hover {
    background: var(--sb-accent-hover);
    transform: scale(1.1);
    box-shadow: 0 0 15px var(--sb-accent);
}

.sb-cancel-edit-btn:hover {
    background: rgba(255, 85, 85, 0.2);
    color: #ff5555;
    transform: scale(1.1);
}

.sb-editor-actions-right {
    margin-left: auto;
    display: flex;
    gap: 8px;
    align-items: center;
}

/* Left controls mirror right controls */
.sb-controls-left {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 4px;
}

.sb-controls-left .sb-control-btn {
    width: 2em;
    height: 2em;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: 1px solid var(--sb-glass-border);
    background: rgba(0, 0, 0, 0.3);
    font-size: 0.95rem;
}

.sb-controls-left .sb-control-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--sb-text-muted);
}

/* Buttons */
.sb-btn-primary {
    background: var(--sb-accent);
    border: 1px solid var(--sb-accent);
    color: white;
    padding: 8px 20px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
}

.sb-btn-primary:hover {
    background: var(--sb-accent-hover);
    border-color: var(--sb-accent-hover);
}

/* Custom Scrollbars */
.sb-content::-webkit-scrollbar,
.sb-page-list::-webkit-scrollbar,
.sb-editor::-webkit-scrollbar {
    width: 5px;
}

.sb-content::-webkit-scrollbar-track,
.sb-page-list::-webkit-scrollbar-track,
.sb-editor::-webkit-scrollbar-track {
    background: transparent;
}

.sb-content::-webkit-scrollbar-thumb,
.sb-page-list::-webkit-scrollbar-thumb,
.sb-editor::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 10px;
}

.sb-content::-webkit-scrollbar-thumb:hover,
.sb-page-list::-webkit-scrollbar-thumb:hover,
.sb-editor::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.15);
}

/* Markdown Content Overrides */
.sb-content h1,
.sb-content h2,
.sb-content h3,
.sb-content h4,
.sb-content h5,
.sb-content h6 {
    margin-top: 1em;
    margin-bottom: 0.5em;
    font-weight: 600;
    line-height: 1.25;
    border-bottom: none !important;
    /* Force remove default borders */
    color: var(--sb-accent);
}

.sb-content h1 {
    font-size: 1.5em;
}

.sb-content h2 {
    font-size: 1.3em;
}

.sb-content h3 {
    font-size: 1.1em;
}

.sb-content p {
    margin-bottom: 1em;
    line-height: 1.5;
}

.sb-content ul,
.sb-content ol {
    margin-bottom: 1em;
    padding-left: 2em;
}

.sb-content blockquote {
    border-left: 4px solid var(--sb-accent);
    margin: 1em 0;
    padding-left: 1em;
    color: var(--sb-text-muted);
    background: rgba(255, 255, 255, 0.05);
    padding: 8px 12px;
    border-radius: 0 4px 4px 0;
}

/* Task list checkboxes */
.sb-content ul li input[type="checkbox"] {
    margin-right: 8px;
    accent-color: var(--sb-accent);
}

.sb-content code {
    background: rgba(255, 255, 255, 0.08);
    padding: 2px 5px;
    border-radius: 4px;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.85em;
}

.sb-content pre {
    background: rgba(0, 0, 0, 0.25);
    padding: 14px 16px;
    border-radius: 8px;
    overflow-x: auto;
    margin: 0.8em 0;
    border: 1px solid var(--sb-glass-border);
}

.sb-content blockquote {
    border-left: 3px solid var(--sb-accent);
    margin: 0.8em 0;
    padding: 0.5em 0 0.5em 1em;
    color: var(--sb-text-secondary);
    font-style: italic;
    background: rgba(99, 102, 241, 0.05);
    border-radius: 0 6px 6px 0;
}

.sb-content a {
    color: var(--sb-accent-hover);
    text-decoration: none;
}

.sb-content a:hover {
    text-decoration: underline;
}

/* Pagination Footer */
.sb-pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 16px;
    background: rgba(0, 0, 0, 0.4);
    border-top: 1px solid var(--sb-glass-border);
    font-size: 0.85rem;
    font-family: inherit;
}

.sb-pagination-nav,
.sb-pagination-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.sb-pagination span {
    min-width: 40px;
    text-align: center;
    font-weight: 500;
    opacity: 0.8;
}

.sb-page-prev,
.sb-page-next,
.sb-page-add,
.sb-page-del {
    cursor: pointer;
    padding: 4px;
    transition: all 0.15s ease;
    opacity: 0.6;
}

.sb-page-prev:hover:not(.disabled),
.sb-page-next:hover:not(.disabled) {
    opacity: 1;
    color: var(--sb-accent);
}

.sb-page-add:hover {
    color: var(--sb-accent);
    opacity: 1;
}

.sb-page-del:hover {
    color: #f87171;
    opacity: 1;
}

.sb-page-prev.disabled,
.sb-page-next.disabled {
    opacity: 0.2;
    cursor: not-allowed;
}

/* Page Flip Animation */
.sb-content-wrapper {
    perspective: 1200px;
}

@keyframes page-flip-left {
    0% {
        transform: rotateY(0deg);
        opacity: 1;
    }

    50% {
        transform: rotateY(-90deg);
        opacity: 0.5;
    }

    100% {
        transform: rotateY(0deg);
        opacity: 1;
    }
}

@keyframes page-flip-right {
    0% {
        transform: rotateY(0deg);
        opacity: 1;
    }

    50% {
        transform: rotateY(90deg);
        opacity: 0.5;
    }

    100% {
        transform: rotateY(0deg);
        opacity: 1;
    }
}

.sb-content.page-flip-left {
    animation: page-flip-left var(--sb-flip-speed, 0.4s) ease-in-out;
    transform-origin: right center;
}

.sb-content.page-flip-right {
    animation: page-flip-right var(--sb-flip-speed, 0.4s) ease-in-out;
    transform-origin: left center;
}

/* Fade Animation */
@keyframes page-fade {
    0% {
        opacity: 0;
        transform: scale(0.95);
    }

    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.sb-content.page-fade-left,
.sb-content.page-fade-right {
    animation: page-fade var(--sb-flip-speed, 0.4s) ease-out;
}

/* Slide Animation */
@keyframes page-slide-left {
    0% {
        transform: translateX(30px);
        opacity: 0;
    }

    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes page-slide-right {
    0% {
        transform: translateX(-30px);
        opacity: 0;
    }

    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

.sb-content.page-slide-left {
    animation: page-slide-left var(--sb-flip-speed, 0.4s) ease-out;
}

.sb-content.page-slide-right {
    animation: page-slide-right var(--sb-flip-speed, 0.4s) ease-out;
}

/* Drawer Button */
#spell-book-button {
    cursor: pointer;
}

#spell-book-button i {
    width: 1em;
    text-align: center;
    margin-right: 5px;
}

/* Custom Modal */
#sb-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    z-index: 60001 !important;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sb-modal {
    background: var(--black85, rgba(20, 20, 25, 0.95));
    border: 1px solid var(--sb-glass-border);
    border-radius: var(--sb-radius);
    padding: 24px;
    width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    gap: 16px;
    animation: sb-modal-in 0.2s ease-out;
}

@keyframes sb-modal-in {
    from {
        transform: scale(0.95);
        opacity: 0;
    }

    to {
        transform: scale(1);
        opacity: 1;
    }
}

.sb-modal h3 {
    margin: 0;
    font-size: 1.1rem;
    color: var(--sb-text-primary);
}

.sb-modal-input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--sb-glass-border);
    border-radius: 6px;
    padding: 10px 12px;
    color: var(--sb-text-primary);
    font-size: 1rem;
    outline: none;
    width: 100%;
    box-sizing: border-box;
}

.sb-modal-input:focus {
    border-color: var(--sb-accent);
    background: rgba(255, 255, 255, 0.1);
}

.sb-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.sb-modal-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s;
}

.sb-modal-btn.cancel {
    background: transparent;
    color: var(--sb-text-secondary);
}

.sb-modal-btn.cancel:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--sb-text-primary);
}

.sb-modal-btn.confirm {
    background: var(--sb-accent);
    color: white;
}

.sb-modal-btn.confirm:hover {
    background: var(--sb-accent-hover);
}

/* Icon Picker */
.sb-icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
    gap: 8px;
    max-height: 300px;
    overflow-y: auto;
    padding: 4px;
    /* Custom scrollbar for icon grid */
}

.sb-icon-grid::-webkit-scrollbar {
    width: 5px;
}

.sb-icon-grid::-webkit-scrollbar-track {
    background: transparent;
}

.sb-icon-grid::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 10px;
}

.sb-icon-grid::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.15);
}

.sb-icon-option {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    cursor: pointer;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--sb-glass-border);
    transition: all 0.15s;
    font-size: 1.1rem;
    color: var(--sb-text-secondary);
}

.sb-icon-option:hover {
    background: rgba(255, 255, 255, 0.15);
    color: var(--sb-text-primary);
    transform: translateY(-2px);
}

.sb-icon-option.active {
    background: var(--sb-accent);
    color: white;
    border-color: var(--sb-accent);
    box-shadow: 0 0 10px var(--sb-accent);
}


/* Framing Grid */
.sb-framing-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    width: 180px;
    margin: 10px auto;
}

.sb-frame-option {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--sb-glass-border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
}

.sb-container {
    position: fixed;
    /* z-index managed by JS focusWindow and getDynamicBaseZIndex */
    display: none;
    flex-direction: column;
    background: rgba(0, 0, 0, var(--sb-opacity, 0.85));
    border: 1px solid var(--sb-glass-border);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    overflow: hidden;
    color: #eee;
    font-family: var(--mainFontFamily);
    transition: box-shadow 0.2s;
    font-size: var(--sb-font-scale, 1em);
    resize: both;
    /* Allow user resizing */
    min-width: 200px;
    min-height: 200px;
    max-width: 100vw;
    max-height: 100vh;
}

.sb-background-layer {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: -1;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    filter: blur(var(--sb-blur, 15px)) brightness(0.6);
    opacity: 0;
    transition: opacity 0.5s ease, filter 0.3s ease;
}

.sb-container.sb-bg-active .sb-background-layer {
    opacity: 1;
}

.sb-frame-option:hover {
    background: rgba(255, 255, 255, 0.2);
}

.sb-frame-option.active {
    background: var(--sb-accent);
    border-color: var(--sb-accent);
    box-shadow: 0 0 8px var(--sb-accent);
}

.sb-frame-dot {
    width: 10px;
    height: 10px;
    background: white;
    border-radius: 50%;
    opacity: 0.3;
    transition: all 0.2s;
}

.sb-frame-option.active .sb-frame-dot {
    opacity: 1;
    transform: scale(1.2);
}

/* Background Overlay styles for readability */
.sb-content-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: inherit;
    /* Inherit image for blur effect if we wanted, but standard overlay is safer */
    background-color: rgba(0, 0, 0, 0.75);
    /* Dark overlay */
    z-index: 0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s;
}

.sb-bg-active.sb-content-wrapper::before {
    opacity: 1;
}

/* Ensure content sits above background */
.sb-content,
.sb-editor-container {
    z-index: 1;
    position: relative;
}

/* Drag & Drop Visuals */
.sb-page-item.dragging {
    opacity: 0.5;
    background: color-mix(in srgb, var(--sb-accent) 20%, transparent);
}

.sb-page-item.drag-over {
    border-top: 2px solid var(--sb-accent);
    padding-top: 4px;
    /* compensate for border to avoid jump */
}

/* Blur Slider */
.sb-blur-control {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-top: 10px;
}

.sb-blur-header {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    opacity: 0.8;
}

.sb-blur-slider {
    width: 100%;
    accent-color: var(--sb-accent);
    cursor: pointer;
}

/* Ensure modal buttons look good */
.sb-modal-body button.sb-modal-btn {
    width: 100%;
    margin-bottom: 4px;
}

/* Mobile overrides removed to allow consistent floating window scaling */

/* ═══════════════════════════════════════════════════════════════════════════
   DIALOG MODE (Mobile Inline Panel via top-layer)
   ═══════════════════════════════════════════════════════════════════════════ */
dialog.sb-dialog-wrapper {
    /* Reset default dialog styling */
    padding: 0;
    border: none;
    background: transparent;
    max-width: 100vw;
    /* max-height removed to rely on JS clamping */
    width: 100vw;
    height: 50vh;
    /* Initial */

    /* Position at TOP (Offset for ST Header) */
    margin: 0;
    position: fixed;
    top: 50px;
    bottom: auto;
    left: 0;

    /* Allow overflow for dropdowns */
    overflow: visible;

    /* Top layer handles z-index, but this helps for stacking context */
    z-index: 3005;
    pointer-events: none;
}

dialog.sb-dialog-wrapper:focus {
    outline: none;
}

dialog.sb-dialog-wrapper::backdrop {
    /* Transparent backdrop so user can see chat behind */
    background: transparent;
    pointer-events: none !important;
    /* Allow clicking/scrolling chat behind */
}

dialog.sb-dialog-wrapper .sb-container {
    pointer-events: auto;
    width: 100% !important;
    height: 100% !important;
    position: relative !important;
    top: auto !important;
    left: auto !important;
    bottom: auto !important;
    right: auto !important;
    border-radius: 0 0 12px 12px;

    /* Layout */
    display: flex !important;
    flex-direction: column !important;

    /* Decoration */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--sb-glass-border);
    border-top: none;
}

/* Flexbox Layout Fixes */
.sb-main {
    display: flex;
    flex: 1;
    min-height: 0;
    overflow: hidden;
}

.sb-content-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.sb-content,
.sb-editor-container {
    flex: 1;
    overflow-y: auto;
}



/* Dialog Drag Handle (HTML element) */
.sb-dialog-handle {
    pointer-events: auto !important;
    /* Enable interaction */
    position: absolute;
    top: auto;
    /* Changed from 0 */

    left: 0;
    right: 0;
    bottom: -40px;
    /* Outside */
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: ns-resize;
    touch-action: none;
    z-index: 10001;
    pointer-events: auto;
}

/* ... existing handle pill styles ... */

/* Settings Dialog (Top Layer) */
dialog.sb-settings-dialog {
    padding: 0;
    border: none;
    background: transparent;
    overflow: visible;
    z-index: 3010;
}

dialog.sb-settings-dialog::backdrop {
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
}

/* Ensure modal body scrolls on mobile */
.sb-modal-scroll-area {
    flex: 1;
    /* Changed from overflow-y: auto; max-height: 60vh; */
    overflow-y: auto;
    min-height: 0;
    /* Critical for flex scrolling */
    padding-right: 4px;
    margin-right: -4px;
    /* offset padding */
}

.sb-handle-pill {
    width: 50px;
    height: 6px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 3px;
    transition: background 0.15s ease;
}

/* Ensure content expands when sidebar collapses */
.sb-content,
.sb-content-wrapper {
    flex: 1 !important;
    min-width: 0 !important;
}

.sb-editor {
    width: 100% !important;
    box-sizing: border-box;
}

.sb-dialog-handle:hover .sb-handle-pill,
.sb-dialog-handle:active .sb-handle-pill {
    background: rgba(255, 255, 255, 0.8);
}

/* Sidebar Collapse Button */
.sb-sidebar-collapse-btn {
    cursor: pointer;
    padding: 6px;
    margin-right: 8px;
    font-size: 14px;
    transition: all 0.15s ease;
    opacity: 0.7;
}

.sb-sidebar-collapse-btn:hover {
    opacity: 1;
    background: rgba(255, 255, 255, 0.1);
}

/* Collapsed Sidebar State */
/* Collapsed Sidebar State - Fully Hidden */
.sb-sidebar.sb-collapsed {
    width: 0 !important;
    min-width: 0 !important;
    flex: 0 0 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
    border-right: none !important;
    display: none !important;
}

/* Ensure content scrolls but window doesn't drag on text */
.sb-content {
    overscroll-behavior: contain;
}

/* Modal Styles (Dark Glass) */
.sb-modal {
    background: rgba(20, 20, 30, 0.95);
    backdrop-filter: blur(12px);
    border: 1px solid var(--sb-glass-border);
    border-radius: 12px;
    padding: 20px;
    color: var(--sb-text);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.sb-modal-btn {
    background: rgba(255, 255, 255, 0.08);
    /* Dark Glass */
    color: var(--sb-text);
    border: 1px solid var(--sb-glass-border);
    padding: 10px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.95rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    margin-bottom: 8px;
}

.sb-modal-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: var(--sb-accent);
    color: #fff;
}

.sb-modal-btn.confirm {
    background: var(--sb-accent);
    color: #fff;
    border-color: var(--sb-accent);
}

.sb-modal-btn.cancel {
    background: transparent;
    border-color: transparent;
    opacity: 0.7;
}

.sb-modal-btn.cancel:hover {
    opacity: 1;
    background: rgba(255, 50, 50, 0.15);
}

/* Performance Overrides for Mobile */
@media (max-width: 768px) {
    .sb-container {
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        background: rgba(15, 15, 20, 0.98) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5) !important;
    }

    .sb-background-layer {
        filter: brightness(0.4) !important;
        -webkit-filter: brightness(0.4) !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
    }

    .sb-container,
    .sb-page-item,
    .sb-control-btn {
        transition: none !important;
    }
}

/* FULLSCREEN OVERRIDE - Must be at the end to override all duplicate rules */
.sb-container.sb-fullscreen {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    min-width: 0 !important;
    min-height: 0 !important;
    border-radius: 0 !important;
    resize: none !important;
    z-index: 60000 !important;
}

/* Dialog Drag Handle (for mobile dialog mode) */
.sb-dialog-handle {
    display: none;
    /* Hidden when using integrated pagination handle */
}

/* Pagination bar handle (integrated into pagination) */
.sb-pagination-handle {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: ns-resize;
    padding: 8px 0;
    touch-action: none;
}

.sb-handle-pill {
    width: 40px;
    height: 5px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    transition: background 0.2s;
}

.sb-pagination-handle:hover .sb-handle-pill,
.sb-pagination-handle:active .sb-handle-pill,
.sb-dialog-handle:hover .sb-handle-pill,
.sb-dialog-handle:active .sb-handle-pill {
    background: rgba(255, 255, 255, 0.6);
}

/* Make pagination bar stay at bottom and be draggable */
.sb-pagination {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.4);
    border-top: 1px solid var(--sb-glass-border);
    cursor: grab;
    user-select: none;
    -webkit-user-select: none;
    flex-shrink: 0;
    z-index: 10;
}

.sb-pagination:active {
    cursor: grabbing;
}

.sb-pagination-nav,
.sb-pagination-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.sb-pagination-nav span {
    font-size: 0.85rem;
    color: var(--sb-text-secondary);
}

.sb-pagination-nav i,
.sb-pagination-actions i {
    cursor: pointer;
    padding: 4px;
    color: var(--sb-text-muted);
    transition: color 0.15s;
}

.sb-pagination-nav i:hover,
.sb-pagination-actions i:hover {
    color: var(--sb-text-primary);
}

.sb-pagination-nav i.disabled {
    opacity: 0.3;
    pointer-events: none;
}

/* Page Animations */
.sb-content {
    backface-visibility: hidden;
    /* For smooth 3D flip */
}

.sb-content.page-flip-left {
    animation: sb-flip-in-left ease forwards;
    transform-origin: left center;
}

.sb-content.page-flip-right {
    animation: sb-flip-in-right ease forwards;
    transform-origin: right center;
}

.sb-content.page-fade-left,
.sb-content.page-fade-right {
    animation: sb-fade-in ease forwards;
}

.sb-content.page-slide-left {
    animation: sb-slide-in-left ease forwards;
}

.sb-content.page-slide-right {
    animation: sb-slide-in-right ease forwards;
}

@keyframes sb-flip-in-left {
    from {
        transform: perspective(1000px) rotateY(-90deg);
        opacity: 0;
    }

    to {
        transform: perspective(1000px) rotateY(0);
        opacity: 1;
    }
}

@keyframes sb-flip-in-right {
    from {
        transform: perspective(1000px) rotateY(90deg);
        opacity: 0;
    }

    to {
        transform: perspective(1000px) rotateY(0);
        opacity: 1;
    }
}

@keyframes sb-fade-in {
    from {
        opacity: 0;
    }

    to {
        opacity: 1;
    }
}

@keyframes sb-slide-in-left {
    from {
        transform: translateX(-50px);
        opacity: 0;
    }

    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes sb-slide-in-right {
    from {
        transform: translateX(50px);
        opacity: 0;
    }

    to {
        transform: translateX(0);
        opacity: 1;
    }
}